name: Update All GeoData Assets

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 20 * * *' # æ¯å¤©åŒ—äº¬æ—¶é—´å‡Œæ™¨ 4 ç‚¹ (UTC 20:00)
  push:
    branches:
      - main
    paths:
      - '.github/workflows/update-geodata.yml'

permissions:
  contents: write

jobs:
  download-sort-push:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} # ä½¿ç”¨ GH CLI å¿…é¡»é…ç½® Token
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download and Sort Assets
        run: |
          # å®šä¹‰æ•´ç†å‡½æ•°ï¼šæ ¹æ®æ–‡ä»¶åç§»åŠ¨åˆ°å¯¹åº”å­æ–‡ä»¶å¤¹
          function sort_files() {
            local author_dir=$1
            cd "$author_dir" || return

            # åˆ›å»ºåˆ†ç±»æ–‡ä»¶å¤¹
            mkdir -p geoip geosite asn uncategorized

            # éå†å½“å‰ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶ (æ’é™¤ç›®å½•æœ¬èº«)
            find . -maxdepth 1 -type f | while read file; do
              filename=$(basename "$file")
              # è½¬æ¢ä¸ºå°å†™ä»¥ä¾¿åŒ¹é…
              lower_name=$(echo "$filename" | tr '[:upper:]' '[:lower:]')

              if [[ "$lower_name" == *"geoip"* ]] || [[ "$lower_name" == *".mmdb"* ]]; then
                mv "$filename" geoip/
              elif [[ "$lower_name" == *"geosite"* ]] || [[ "$lower_name" == *"dlc.dat"* ]]; then
                mv "$filename" geosite/
              elif [[ "$lower_name" == *"asn"* ]]; then
                mv "$filename" asn/
              else
                # å‰©ä¸‹çš„æ”¾å…¥æœªåˆ†ç±» (é€šå¸¸æ˜¯æ ¡éªŒæ–‡ä»¶æˆ–è¯´æ˜æ–‡æ¡£)
                mv "$filename" uncategorized/
              fi
            done
            
            # åˆ é™¤ç©ºæ–‡ä»¶å¤¹ (å¦‚æœæŸä¸ªåˆ†ç±»æ²¡æœ‰æ–‡ä»¶)
            rmdir geoip geosite asn uncategorized 2>/dev/null || true
            cd - > /dev/null
          }

          # åˆ›å»ºä¸´æ—¶å·¥ä½œåŒº
          mkdir -p workspace
          cd workspace

          echo "ğŸš€ å¼€å§‹æ‰¹é‡ä¸‹è½½..."

          # --- 1. MetaCubeX (Tag: latest) ---
          echo "â¬‡ï¸ Downloading MetaCubeX..."
          mkdir -p MetaCubeX
          gh release download latest --repo MetaCubeX/meta-rules-dat --dir MetaCubeX --pattern "*" --clobber
          sort_files "$(pwd)/MetaCubeX"

          # --- 2. DustinWin (Tag: mihomo-geodata) ---
          echo "â¬‡ï¸ Downloading DustinWin..."
          mkdir -p DustinWin
          gh release download mihomo-geodata --repo DustinWin/ruleset_geodata --dir DustinWin --pattern "*" --clobber
          sort_files "$(pwd)/DustinWin"

          # --- 3. NobyDa (Tag: latest) ---
          echo "â¬‡ï¸ Downloading NobyDa..."
          mkdir -p NobyDa
          gh release download --repo NobyDa/geoip --dir NobyDa --pattern "*" --clobber
          sort_files "$(pwd)/NobyDa"

          # --- 4. Loyalsoldier (Tag: latest, Multi-repo) ---
          echo "â¬‡ï¸ Downloading Loyalsoldier..."
          mkdir -p Loyalsoldier
          # ä¸‹è½½ repo 1: v2ray-rules-dat (é€šå¸¸åŒ…å«æœ€å…¨çš„ dat)
          gh release download --repo Loyalsoldier/v2ray-rules-dat --dir Loyalsoldier --pattern "*" --clobber
          # ä¸‹è½½ repo 2: geoip (å¯èƒ½ä¼šè¦†ç›–ä¸Šé¢çš„åŒåæ–‡ä»¶ï¼Œä»¥æœ€åä¸‹è½½çš„ä¸ºå‡†)
          gh release download --repo Loyalsoldier/geoip --dir Loyalsoldier --pattern "*" --clobber
          sort_files "$(pwd)/Loyalsoldier"

          # --- 5. xream (Tag: latest) ---
          echo "â¬‡ï¸ Downloading xream..."
          mkdir -p xream
          gh release download --repo xream/geoip --dir xream --pattern "*" --clobber
          sort_files "$(pwd)/xream"

          echo "âœ… æ‰€æœ‰æ–‡ä»¶ä¸‹è½½å¹¶åˆ†ç±»å®Œæ¯•ã€‚"

      - name: Push to GeoData Branch
        run: |
          # å‡†å¤‡æ¨é€ç¯å¢ƒ
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"

          # åˆ‡æ¢åˆ°å­¤å„¿åˆ†æ”¯ GeoData (æ— å†å²è®°å½•ï¼Œçº¯å‡€æ¨¡å¼)
          git checkout --orphan GeoData
          
          # æ¸…ç©ºæš‚å­˜åŒºå’Œå½“å‰ç›®å½•
          git rm -rf .
          
          # å°† workspace ä¸­çš„å†…å®¹ç§»å‡ºæ¥
          cp -r workspace/* .
          rm -rf workspace

          # æ·»åŠ æ–‡ä»¶
          git add .

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜åŒ–
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰æ–‡ä»¶æ›´æ–°ï¼Œè·³è¿‡æäº¤ã€‚"
          else
            git commit -m "Auto-update assets: $(date +'%Y-%m-%d %H:%M:%S')"
            git push -f origin GeoData
          fi
